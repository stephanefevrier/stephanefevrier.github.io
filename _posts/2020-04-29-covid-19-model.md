---
layout: post
title:  "COVID-19 compartmental model"
date:   2020-04-29 14:14:20 +0200
categories: Health
permalink: covid-19-model
---

<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


<!-- {% include construction.html %} -->

This page explores the possibility of fitting a compartmental model for the propagation of COVID-19 in France, making a projection until after the nation-wide containment end. 

The first part explains the concept of compartmental models and describes the equations used, while the second part shows the data used, the fitted model and its results.

Data is gathered from the <a href="https://github.com/CSSEGISandData/COVID-19" target="_blank">Johns Hopkins Github repository</a> and <a href="https://www.kaggle.com/sudalairajkumar/novel-corona-virus-2019-dataset" target="_blank">Kaggle</a>. The code is maintained on <a href="https://github.com/stephanefevrier/covid-19-analysis" target="_blank">this repository</a>, made with Python on a Jupyter notebook.


# Compartmental models

This first part quickly explains the concept of compartmental models and describes the equations used for the model.

Compartmental models are a simple way to model the spread of infectious diseases by separating the population into several meaningful compartments. One of the simplest example of a compartmental model is the SIR model, which is explained below to introduce the concept of compartmental models before showing the actual model used here.

## Quick introduction: SIR model

The SIR model, deterministic and based on ordinary differential equations, consists of 3 compartments: Susceptible ($$S$$), Infectious ($$I$$), and $$R$$ (Recovered). 

### Compartments

Each variable ($$S$$, $$I$$, $$R$$) represents the number of people in the associated compartment and depends on time:

- $$S(t)$$: number of susceptible people on day $$t$$ (no exposition to the disease)
- $$I(t)$$: number of infectious people on day $$t$$ (carrying the disease and being infectious)
- $$R(t)$$: number of recovered people on day $$t$$ (had the disease, being immune or dead)

### Equations

The SIR system can be expressed by the following set of ordinary differential equations:

$$\frac{dS}{dt} = -\beta \cdot I \cdot \frac{S}{N}$$ 

$$\frac{dI}{dt} = \beta \cdot I \cdot \frac{S}{N} - \gamma \cdot I$$

$$\frac{dR}{dt} = \gamma \cdot I$$ 

- $$\frac{dS}{dt}$$: $$I$$ infectious people can infect a proportion of $$S/N$$ people, each decreasing the $$S$$ population by $$\beta$$.
- $$\frac{dI}{dt}$$: The population going out of $$S$$ comes to $$I$$ (previous equation, opposite sign). Also, $$I$$ people recover at a rate of $$\gamma$$.
- $$\frac{dR}{dt}$$: The population going out of $$I$$ comes to $$R$$ (second term of previous equation, opposite sign).

### Parameters

The equations are solved using the initial conditions ($$S_0$$, $$I_0$$, $$R_0$$), along with the following set of parameters:

- $$N$$: total population
- $$\beta$$: expected amount of people an infectious person infects per day (probability of an infectious person to infect a healthy person $$\times$$ average number of people a person is in contact with per day)
- $$\gamma$$: rate of recovery,  or proportion of infectious recovering per day (inverse of number of days that an infectious person has and can spread the disease)
- $$R_0 = \beta / \gamma$$: basic reproduction number, expected total number of people an infectious person infects.


## Advanced compartmental model: SEICRD model

To be closer to reality, more compartments can be added and the relationship between each of them can be adjusted. Taking into account the specificities of COVID-19, a more advanced comportmental model (SEICRD) is built. It is a modification of the one presentend in <a href="https://towardsdatascience.com/infectious-disease-modelling-fit-your-model-to-coronavirus-data-2568e672dbc7" target="_blank">this article</a>.

The SEICRD model consists of 5 compartments: Susceptible ($$S$$), Exposed ($$S$$), Infectious ($$I$$), Critical ($$C$$), $$R$$ (Recovered), and Dead ($$D$$). 

### Compartments

Each variable ($$S$$, $$E$$, $$I$$, $$C$$, $$R$$, $$D$$) represents the number of people in the associated compartment and depends on time:

- $$S(t)$$: number of susceptible people on day $$t$$ (no exposition to the disease)
- $$E(t)$$: number of exposed people on day $$t$$ (carrying the disease without symptoms, not infectious)
- $$I(t)$$: number of infectious people on day $$t$$ (carrying the disease and being infectious)
- $$C(t)$$: number of critical people on day $$t$$ (carrying the disease, critically ill, being at hospital)
- $$R(t)$$: number of recovered people on day $$t$$ (had the disease, recovered and immune to it)
- $$D(t)$$: number of dead people on day $$t$$ (had the disease, died of it)

### Equations

The SEICRD system can be expressed by the following set of ordinary differential equations:

$$\frac{dS}{dt} = -\beta(t) \cdot I \cdot \frac{S}{N}$$ 

$$\frac{dE}{dt} = \beta(t) \cdot I \cdot \frac{S}{N} - \delta \cdot E$$ 

$$\frac{dI}{dt} = \delta \cdot E - \frac{1}{12} \cdot p(I→C) \cdot I - \gamma \cdot (1 - p(I→C)) \cdot I$$ 

$$\frac{dC}{dt} = \frac{1}{12} \cdot p(I→C) \cdot I - \frac{1}{7.5} \cdot p(C→D) \cdot min(Beds,C) - max(0,C-Beds) - \frac{1}{6.5} \cdot (1-p(C→D)) \cdot min(Beds,C)$$ 

$$\frac{dR}{dt} = \gamma \cdot (1-p(I→C)) \cdot I + \frac{1}{6.5} \cdot (1-p(C→D)) \cdot min(Beds,C)$$ 

$$\frac{dD}{dt} = \frac{1}{7.5} \cdot p(C→D) \cdot min(Beds,C) + max(0,C-Beds)$$ 


Which can be explained as follows:

- $$\frac{dS}{dt}$$: $$I$$ infectious people can infect $$S/N$$ people at a rate of $$\beta$$.

- $$\frac{dE}{dt}$$: The population going out of $$S$$ comes to $$E$$ (previous equation, opposite sign). Exposed people $$E$$ get infectious at a rate of $$\delta$$.

- $$\frac{dI}{dt}$$: The population going out of $$E$$ comes to $$I$$. A proportion $$p(I→C)$$ of $$I$$ people get critically ill and goes to $$C$$ at a rate of $$1/12$$, and a proportion $$1 - p(I→C)$$ of $$I$$ people recover and goes to $$R$$ at a rate of $$\gamma$$.

- $$\frac{dC}{dt}$$: A proportion of $$p(I→C)$$ people going out of $$I$$ comes to $$C$$ at a rate of $$1/12$$. A proportion $$p(C→D)$$ of $$min(Beds(t),C)$$ people dies and goes to $$D$$ at a rate of $$1/7.5$$; All $$max(0,C-Beds(t))$$ people go to $$D$$ and die due to bed shortage; a proportion $$1-p(C→D)$$ of $$min(Beds(t),C)$$ people recovers and goes to $$R$$ at a rate of $$1/6.5$$.

- $$\frac{dR}{dt}$$: A proportion of $$1-p(I→C)$$ people going out of $$I$$ comes to $$R$$ at a rate of $$\gamma$$. A proportion $$1-p(C→D)$$ of $$min(Beds(t),C)$$ people goint out of $$C$$ comes to $$R$$ at a rate of $$1/6.5$$ (fourth term of previous equation, opposite sign).

- $$\frac{dD}{dt}$$: A proportion of $$p(C→D)$$ people going out of $$C$$ goes to $$D$$ at a rate of $$1/7.5$$. All $$max(0,C-Beds(t))$$ people going out of $$C$$ go to $$D$$ and die due to bed shortage.

### Time dependent variables

It can be noted in the previous equations that $$\beta(t)$$ is time-dependent: it depends on $$R_0(t)$$, which is supposed to be varying through time, taking into account the effect of a lockdown for example. A logistic function is used to describe $$R_0(t)$$ before and during lockdown:
 
$$ R_0(t) = \frac{R_0 start - R_0 end}{1 + e^{-k(-x + x_0)}} + R_0 end $$

### Parameters

The equations are solved using the initial conditions ($$S_0$$, $$E_0$$, $$I_0$$, $$C_0$$, $$R_0$$, $$D_0$$), along with the following set of parameters:

- $$N$$: total population 
- $$\beta(t)$$: expected amount of people an infectious person infects per day
- $$\gamma$$: rate of infectious recovering per day
- $$\delta$$: rate of exposed getting infectious per day (inverse of incubation period)
- $$p(I→C)$$: probability of going from infectious to critical 
- $$p(C→D)$$: probability of dying while critical 
- $$Beds$$: number of ICU beds available 
- $$R_0start$$: initial value of $$R_0(t)$$ 
- $$R_0end$$: final value of $$R_0(t)$$ 
- $$x_0$$: inflection point of $$R_0(t)$$ (equivalent of lockdown day)
- $$k$$: steepness of $$R_0(t)$$

# Using the model: predicting evolution in France

The model has been described. The objective is to use it to make a prediction about the evolution of the situation in France. 

## Hypotheses and limitations

A model is helpful to gain some insight, but never fully reflects reality. It is always bounded to a set of hypotheses, thus imposing limitations. The following needs to be considered before interpreting the model's results:

- The total population is constant: $$S(t) + E(t) + I(t) + C(t) + R(t) + D(t) = N$$. 
- Deaths do not change the population structure (age groups proportions). Vital dynamics such as birth and nutural death are not taken into account.
- The population is assumed to act homogeneously (described in average).
- The number of beds only impacts the critical cases, which are taken care of at hospital. All critical patients that do not get treatment die.
- Individuals are immune after recovering.
- The system is extremely sensitive to initial conditions and parameters. It can be considered chaotic, as a slight change can lead to completely different outcomes.

## Fixed parameters: data used

To lower the degrees of freedom during fitting, multiple parameters are set based on various estimates. However, it must be kept in mind that data is incomplete and the measurement is inconsistent between countries. 

As seen in the equations, the rate of becoming critically ill is set as $$1/12$$, the rate of dying is set at $$1/7.5$$, and the rate of recovering while being critically ill is set at $$1/6.5$$. The rate of getting infectious is estimated at $$\delta = 1/3$$, and the rate of recovering while being infectious is set at $$\gamma = 1/9$$.

The number of beds is 7569.58 (calculated from the number of beds per a hundred thousand inhabitants). It is supposed to be constant, although it actually increased during that period.

The lockdown starts at March 17 ($$x_0$$) and end at May 11. The logistic evolution of $$R_0(t)$$ is true only during and before the lockdown. After, it is set at 1.1 to emulate the effect of a French population going out of lockdown.

Finally, the population repartition by age group for France is known, along with an estimate of the global probability of going to ICU per age group and of dying at ICU per age group (see below).


<iframe width="100%" height="600" frameborder="0" scrolling="no" src="//plotly.com/~stephanefevrier/298.embed?showlink=false"></iframe>

To easily include this data to the model, a weighted sum is used:

- probability of going to ICU $$p(I→C ) = 4.1\%$$
- probability of dying at ICU $$p(C→D) = 26.2\%$$

## Parameters to fit 

3 parameters need to be fitted: $$R_0start$$, $$k$$, and $$R_0end$$. Estimations give $$R_0$$ close to 3.6 before lockdown and 0.7 during lockdown. As a result, these will be the initial values given to $$R_0start$$ and $$R_0end$$ at the beginning of the fitting process, while variations are allowed.

The remaining parameter $$k$$ corresponding to the steepness of the logistic curve, can vary between $$0^+$$ and 5.

## Data used for the fitting

The number of deaths is supposed to be the closest to reality, compared to the number of confirmed and recovered cases. As a consequence, it is used to fit the data. As a reminder, the counting method can vary between countries and is always different from reality, but it can be used as a nice approximation of reality.

As the $$D$$ compartment is supposed to fit the counted number of deaths, another parameter needs to be considered: the outbreak shift. Available data starts at January 22, but the model need to start with the first case (considering the initial conditions to be $$S_0 = N-1$$, $$E_0 = 1$$, all other compartments to zero). The outbreak shift allows to set a different starting date. Being an integer, the optimization process was done separately from the fitting. The best results are given with an outbreak shift of 26 days, meaning that the first case in France is supposed to be on December 27, 2019. 

## Fitted model

The fitting process is done using <a href="https://lmfit.github.io/lmfit-py/" target="_blank">LMFIT</a>, a Non-Linear Least-Squares Minimization module for Python. The first plot show the fitted curve against real data. The other compartments can be displayed by clicking on the legend.

Fitting residuals are mostly evenly spread, with the exception of the first curvature (around March 20). An important result is the number of deaths predicted at lockdown end: 27,236. 

The fitted curve is extended until June 10, with a prediction of 33,104 deaths. As the sensitivity is important, no long time prediction is made, because it is non sense.

<!-- main SEICRD -->
<iframe width="100%" height="500" frameborder="0" scrolling="no" src="//plotly.com/~stephanefevrier/241.embed?showlink=false"></iframe>

The next plot shows the evolution of the $$R_0$$. Fitted parameters: $$R_0start =  3.80$$, $$R_0end = 0.69$$, $$k = 0.14$$. The initial $$R_0$$ is higher than the estimation of 3.6, while the final $$R_0$$ corresponds to the 0.7 estimate.

It can be noted that $$k$$ is close to 0, resulting in a low steepness. $$R_0$$ starts to decrease before the lockdown beginning, and is already down to 2.35 when it starts. This what let like this, as it can be seen as an averaged evolution. It allows an easier optimization process.
Finally, $$R_0 = 1.1$$ instantly after lockdown, as parametrized.

<!-- SEICRD R_0 -->
<iframe width="100%" height="500" frameborder="0" scrolling="no" src="//plotly.com/~stephanefevrier/243.embed?showlink=false"></iframe>


<!-- SEICRD Fatality Rate -->
<!--
<iframe width="100%" height="500" frameborder="0" scrolling="no" src="//plotly.com/~stephanefevrier/245.embed?showlink=false"></iframe>
-->

The last plot shows the number of daily deaths, fitted against real data. At the date of l, the fit seems pretty good considering the data dispersion. 

A spike of deaths is seen around March 29, corresponding to an ICU over capacity for the model. As it looks to fit well, it could also be an overfit; the interpretation of the number of people dying litteraly because they have no bed is maybe too naive, but sufficient for such a model.

After lockdown, the estimated daily number of deaths goes from 190 to 230.



We have a nice bell, and after lockdown the nb of dead/day is of almost 200 per day. Which is high. But it is to see what will happen if social distancing is not really taken care of.

Also, this model should be of course taken as an averaged pedcition. It is not extended for too many days as it is too sensitive to initial conditions, making it unreliable for long-term predictions. 



- We have the bell shape

<!-- SEICRD Deaths per day -->
<iframe width="100%" height="500" frameborder="0" scrolling="no" src="//plotly.com/~stephanefevrier/247.embed?showlink=false"></iframe>

# Keeping track of the model: updating data

As new data is available everyday, it is interesting to assess how well the model is doing and to possibly adjust it. 

## Update 1: data up to May 11

The model made a prediction of 27,236 deaths on May 11. The real numbers are 26,646 deaths, which is only a 2.2% error.

A new fit is proposed below, with slightly more freedom on the values. Fitted parameters: $$R_0start =  3.80$$, $$R_0end = 0.69$$, $$k = 0.14$$. 

<!-- main SEICRD -->
<iframe width="100%" height="500" frameborder="0" scrolling="no" src="//plotly.com/~stephanefevrier/334.embed?showlink=false"></iframe>

<!-- SEICRD R_0 -->
<iframe width="100%" height="500" frameborder="0" scrolling="no" src="//plotly.com/~stephanefevrier/336.embed?showlink=false"></iframe>

<!-- SEICRD Deaths per day -->
<iframe width="100%" height="500" frameborder="0" scrolling="no" src="//plotly.com/~stephanefevrier/340.embed?showlink=false"></iframe>

The effects of going out of lockdown can take time to appear, thus will be assessed later.

# To go further

- need to re estimate parameters (gamma and delta, nb of beds)
